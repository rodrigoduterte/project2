<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
        crossorigin="anonymous">
    <link type="text/css" href="http://code.cloudcms.com/alpaca/1.5.24/bootstrap/alpaca.min.css" rel="stylesheet">
    <!-- jquery -->
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
        crossorigin="anonymous"></script>
    <!-- moment -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <!-- bootstrap -->
    <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"> -->
    <!-- handlebars -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.js"></script>
    <!-- alpaca -->
    <script type="text/javascript" src="https://code.cloudcms.com/alpaca/1.5.24/bootstrap/alpaca.min.js"></script>
    <!-- jquery ui -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
    <!-- Required for jQuery UI DateTimePicker control -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.js"></script>
    <link type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.css"
        rel="stylesheet">
    <!-- Required for inputmask -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.maskedinput/1.4.1/jquery.maskedinput.min.js"></script>

    <!-- Beautify used by EditorField -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.7.5/beautify.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.7.5/beautify-css.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.7.5/beautify-html.min.js" type="text/javascript" charset="utf-8"></script>
    <!-- typeahead.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/corejs-typeahead/1.2.1/bloodhound.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/corejs-typeahead/1.2.1/typeahead.bundle.min.js" type="text/javascript"></script>
    <!-- ckeditor for the ckeditor field -->
    <script src="https://cdn.ckeditor.com/4.10.0/standard/ckeditor.js" type="text/javascript"></script>
    <!-- bootstrap datetimepicker for date, time and datetime controls -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>
    <link rel="stylesheet" media="screen" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.css">
    <!-- bootstrap-multiselect for time field -->


    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.15/js/bootstrap-multiselect.js"></script>
    <link rel="stylesheet" media="screen" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.15/css/bootstrap-multiselect.css">

    <!-- jQuery Price Format for currency field -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-price-format/2.2.0/jquery.priceformat.min.js"></script>
    <!-- START - Google Analytics -->
    <script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
        ga('create', 'UA-74723052-1', 'auto');
        ga('send', 'pageview');
    </script>
    <!-- END - Google Analytics -->
    <!-- pretty print -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.css">
</head>

<body>
    <!--Custom Script-->

    <div class="container">
        <nav class="navbar nabar-dark bg-dark">
            <span class="navbar-brand mb-0 text-white"><strong>SALE REMINDER</strong></span>
            <div class="navbar float-right">
                <a class="nav-link  text-white" href="/customers">CUSTOMER</a>
                <a class="nav-ulnk  text-white" href="/reports">REPORTS</a>
            </div>
        </nav>
        <div class="row">
            <!-- Showing Today Date here -->
            <div class="col-md-6">
                <div id="followupForm"></div>
            </div>
            <div class="col-md-6">
                <div id="followupTable"></div>
            </div>
        </div>
    </div>
    <script>

        var dateEditor = function (cell, onRendered, success, cancel) {
            //cell - the cell component for the editable cell
            //onRendered - function to call when the editor has been rendered
            //success - function to call to pass the succesfully updated value to Tabulator
            //cancel - function to call to abort the edit and return to a normal cell

            //create and style editor
            var editor = $("<input type='date'></input>");
            editor.css({
                "padding": "3px",
                "width": "100%",
                "box-sizing": "border-box",
            });

            //Set value of editor to the current value of the cell
            editor.val(moment(cell.getValue(), "YYYY-MM-DD").format("YYYY-MM-DD"));

            //set focus on the select box when the editor is selected (timeout allows for editor to be added to DOM)
            onRendered(function () {
                editor.focus();
                editor.css("height", "100%");
            });
            //when the value has been set, trigger the cell to update
            editor.on("change blur", function (e) {
                success(moment(editor.val(), "YYYY-MM-DD").format("YYYY-MM-DD"));
            });
            //return the editor element
            return editor;
        };
        var statusOptions = {
            "1": "Customer is Busy",
            "2": "Call but no answer",
            "3": "Need to discuss",
            "4": "Already purchased",
            "5": "No longer Need",
            "6": "Not purchase now",
            "7": "Follow up Sales Order",
            "8": "Shipped",
            "9": "Order Completed"
        };
        var actionMap = {
            "1": ["Call back"],
            "2": ["Call back"],
            "3": ["Follow-Up", "Change lead status to Dropped"],
            "4": ["Follow-Up", "Change lead status to Dropped"],
            "5": ["Follow-Up", "Change lead status to Dropped"],
            "6": ["Change lead status to Potential"],
            "7": ["Request shipping Date", "Waiting to Ship", "Check Inventory"],
            "8": ["No Action needed"],
            "9": ["No Action needed"]
        };    
    </script>
    <script>
        var now = new Date();
    </script>
    <script>
        var dataf = function (callback) {
            var value = this.observable("/status").get();
            callback(actionMap[value]);
        };
        $(document).ready(function () {
            $("#followupTable").tabulator({
                pagination: "local",
                paginationSize: 6,
                height: "450px",
                layout: "fitDataFill",
                columns: [
                    { title: "Followup ID", field: "id", visible: false },
                    { title: "Full Name", field: "fullname", sorter: "string", width: 200, editor: false, headerFilter: "input" },
                    {
                        title: "Followup Status", field: "status", width: 200, headerFilter: "input",
                        editor: function (cell, onRendered, success, cancel) {
                            var select = $("<select></select>");
                            $.getJSON('/api/status', function (data) {
                                status = data;
                                Object.keys(data).forEach((value) => {
                                    select.append("<option value='" + value + "'>" + data[value] + "</option>");
                                });
                            });
                            onRendered(function () {
                                select.focus();
                                select.css("height", "100%");
                                select.css("width", "100%");
                            });
                            select.on("change", function (e) {
                                success(select.val());
                            });

                            return select;
                        },
                        formatter: function (cell, params) {
                            //console.log("value  " + value);
                            //console.log("data  " + JSON.stringify(data));
                            //console.log("type  " + type);
                            //console.log("params  " + params);
                            // console.log("xxxxx " + status[value.toString()]);
                            console.log(cell.getValue());
                            console.log(params.status[cell.getValue()]);
                            return params.status[cell.getValue()];
                        },
                        formatterParams: { status: statusOptions }
                    },
                    {
                        title: "Followup Action", field: "action", sorter: "string", headerFilter: "input",
                        editor: function (cell, onRendered, success, cancel) {
                            var select = $("<select></select>");
                            //console.log(cell.cell.row.data.status);
                            //console.log(actionMap[cell.cell.row.data.status]);
                            onRendered(function () {
                                select.focus();
                                select.css("height", "100%");
                                select.css("width", "100%");
                            });
                            select.on("change", function (e) {
                                success(select.val());
                            });

                            actionMap[cell.cell.row.data.status].forEach(opt => {
                                select.append("<option value='" + opt + "'>" + opt + "</option>");
                            });
                            return select;
                        }
                    },
                    { title: "Due Date", field: "duedate", sorter: "date", editor: dateEditor },
                    { title: "Memo", field: "memo", align: "center", width: 100, editor: true },
                    { title: "Open Followup", field: "open", editor: "tick", formatter: "tickCross" }
                ],
                cellEdited: function (cell) {
                    console.log(cell);
                    console.log('Column Updated: ' + cell.cell.column.field);
                    console.log('Followup ID Updated: ' + cell.cell.row.data.id);
                    console.log('Old Value: ' + cell.cell.oldValue);
                    console.log('New Value: ' + cell.cell.value);

                    $.ajax({
                        method: 'PUT',
                        data: JSON.stringify({
                            columnName: cell.cell.column.field,
                            columnValue: cell.cell.value
                        }),
                        url: "".concat("/api/followup?id=", cell.cell.row.data.id),
                        contentType: "application/json; charset=utf-8"
                    });
                },
                ajaxURL: "/api/followups?id=1", //ajax URL
                ajaxConfig: "GET", //ajax HTTP request type
            });

            $("#followupForm").alpaca({
                "schema": {
                    "title": "New Followup",
                    "type": "object",
                    "properties": {
                        "customer": {
                            "type": "string",
                            "title": "Customer"
                        },
                        "status": {
                            "type": "string",
                            "title": "Followup Status"
                        },
                        "action": {
                            "type": "string",
                            "title": "Followup Action"
                        },
                        "duedate": {
                            "type": "string",
                            "title": "Due Date",
                            "format": "date"
                        },
                        "memo": {
                            "type": "string",
                            "title": "Memo"
                        }
                    }
                },
                "options": {
                    "form": {
                        "attributes": {
                            "action": "/api/followup",
                            "method": "post"
                        },
                        "buttons": {
                            "submit": {
                                "title": "Submit",
                                "type": "button",
                                "click": function () {
                                    var list = [{ "customer": "CustomerId" }, { "status": "FollowupStatusTypeId" },
                                    { "action": "action" }, { "duedate": "duedate" }, { "memo": "memo" }];
                                    var newfollowup = {}
                                    list.forEach(
                                        function (value, number, array) {
                                            var key = Object.keys(value).toString();
                                            if ($("#" + key).val() !== "") {
                                                newfollowup[value[key]] = isNaN(parseInt($("#" + key).val())) ? $("#" + key).val() : parseInt($("#" + key).val());
                                            }
                                        }
                                    )


                                    $.post('/api/followup', newfollowup, function (data2) {
                                        $.getJSON('/api/followups?id=1', function (data) {
                                            $("#followupTable").tabulator("setData", data);
                                        });

                                        $("#followupForm").alpaca("get").childrenByPropertyId["customer"].setValue("");
                                        $("#followupForm").alpaca("get").childrenByPropertyId["status"].setValue("");
                                        $("#followupForm").alpaca("get").childrenByPropertyId["action"].setValue("");
                                        $("#followupForm").alpaca("get").childrenByPropertyId["duedate"].setValue("");
                                        $("#followupForm").alpaca("get").childrenByPropertyId["memo"].setValue("");
                                    });
                                }
                            }
                        }
                    },
                    "fields": {
                        "customer": {
                            "id": "customer",
                            "hideNone": true,
                            "dataSource": function (cb) {
                                $.getJSON("/api/cb/customers", function (data) {
                                    console.log(data);
                                    cb(data);
                                })
                            },
                            "type": "select"
                        }
                        ,
                        "status": {
                            "hideNone": true,
                            "dataSource": [
                                {
                                    "value": 1,
                                    "text": "Customer is Busy"
                                },
                                {
                                    "value": 2,
                                    "text": "Call but no answer"
                                },
                                {
                                    "value": 3,
                                    "text": "Need to discuss"
                                },
                                {
                                    "value": 4,
                                    "text": "Already purchased"
                                },
                                {
                                    "value": 5,
                                    "text": "No longer Need"
                                },
                                {
                                    "value": 6,
                                    "text": "Not purchase now"
                                },
                                {
                                    "value": 7,
                                    "text": "Follow up Sales Order"
                                },
                                {
                                    "value": 8,
                                    "text": "Shipped"
                                },
                                {
                                    "value": 9,
                                    "text": "Order Completed"
                                }
                            ],
                            "id": "status",
                            "type": "select"
                        },
                        "action": {
                            "hideNone": true,
                            "dataSource": dataf,
                            "type": "select",
                            "id": "action"
                        },
                        "duedate": {
                            "type": "date",
                            "picker": {
                                "minDate": new Date().setDate(now.getDate())
                            },
                            "manualEntry": true,
                            "id": "duedate"
                        },
                        "memo": {
                            "type": "textarea",
                            "id": "memo"
                        }
                    }
                },
                "postRender": function (control) {
                    var status = control.childrenByPropertyId["status"];
                    var action = control.childrenByPropertyId["action"];
                    console.log(action);
                    $("#action").append(new Option("Call back", "Call back", true, true));
                    status.on("change", function () {
                        action.refresh();
                    });
                }
            });
        });
        window.onload = function () {
            $("#customer").editableSelect();
        }
    </script>
    <!-- <script src="https://rawgithub.com/indrimuska/jquery-editable-select/master/dist/jquery-editable-select.min.js"></script> -->
    <script src="./js/jquery-editable-select.js"></script>
    <!-- <link href="https://rawgithub.com/indrimuska/jquery-editable-select/master/dist/jquery-editable-select.min.css" rel="stylesheet"> -->
    <link href="./styles/jquery-editable-select.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.5.3/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.5.3/js/tabulator.min.js"></script>
</body>